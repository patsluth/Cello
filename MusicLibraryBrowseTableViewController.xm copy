//
//  MusicLibraryBrowseTableViewController.xm
//  Cello
//
//  Created by Pat Sluth on 2015-12-21.
//  Copyright (c) 2015 Pat Sluth. All rights reserved.
//

#import "MusicCoalescingEntityValueProvider.h"
#import "MusicEntityValueContext.h"
#import "MusicMediaEntityProvider.h"

#import "MusicContextualUpNextAlertAction.h"
#import "MusicContextualLibraryUpdateAlertAction.h"
#import "MusicContextualRemoveFromPlaylistAlertAction.h"

#import "MusicContextualActionsConfiguration.h"
#import "MusicContextualActionsHeaderViewController.h"

#import <MediaPlayer/MediaPlayer.h>


//#import "MusicMediaAlbumDetailViewController.h"
//#import "MusicProfileAlbumsViewController.h"
//#import "MusicMediaProfileDetailViewController.h"

#import "MPMediaEntity+SW.h"


typedef enum {
    UpNextAlertAction_PlayNext = 0,
    UpNextAlertAction_AddToUpNext = 1
} UpNextAlertAction_Type;


@protocol Cello_MusicEntityTableViewCellValueProviding
@required
@property (nonatomic,retain) id<MusicEntityValueProviding> entityValueProvider;
@end





@interface MusicLibraryBrowseTableViewController : UITableViewController <UIViewControllerPreviewingDelegate>
{
}

//@property (nonatomic,readonly) MusicLibraryViewConfiguration * libraryViewConfiguration;

@property (strong, nonatomic) /*MusicClientContext*/ id clientContext;
@property (strong, nonatomic) /*MusicTableView*/ UITableView *tableView;

- (id)_entityValueContextAtIndexPath:(id)arg1;
- (void)_configureEntityValueContextOutput:(id)arg1 forIndexPath:(id)arg2;

// handles configuring required fields
- (id)cello_entityValueContextAtIndexPath:(NSIndexPath *)indexPath;
- (void)cello_performUpNextAction:(UpNextAlertAction_Type)actionType forIndexPath:(NSIndexPath *)indexPath;
- (void)cello_performDownloadActionForIndexPath:(NSIndexPath *)indexPath;
- (void)cello_performRemoveFromPlaylistActionForIndexPath:(NSIndexPath *)indexPath;
- (UIAlertController *)cello_deleteConfirmationAlertController:(NSIndexPath *)indexPath;

@end













//MusicPreviewViewController
//%hook MusicMediaProductDetailViewController
//
//-(id)initWithContainerEntityProvider:(MusicMediaEntityProvider *)arg1
//tracklistEntityProvider:(MusicMediaEntityProvider *)arg2
//clientContext:(id)arg3
//existingJSProductNativeViewController:(id)arg4
//{
//    id x = %orig(arg1, arg2, arg3, arg4);
//    
//    NSLog(@"PAT initWithContainerEntityProvider \n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n", x, arg1, arg2, arg3, arg4);
//    
//    NSLog(@"***\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n***",
//          arg1.mediaQuery,
//          arg1.mediaQueryDataSource.entities,
//          arg2.mediaQuery,
//          arg2.mediaQueryDataSource.entities);
//    
//    return x;
//}
//
//%end



%hook MusicMediaProfileDetailViewController

-(id)initWithContainerEntityProvider:(id)arg1
clientContext:(id)arg2
existingJSProfileNativeViewController:(id)arg3
profileType:(unsigned long long)arg4
{
    id x = %orig(arg1, arg2, arg3, arg4);
    
    NSLog(@"PAT MusicMediaProfileDetailViewController:initWithContainerEntityProvider \n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n",
          x,
          arg1,
          arg2,
          arg3,
          @(arg4));
    
    return x;
}

%end



























%hook MusicLibraryBrowseTableViewController


- (void)viewDidLoad
{
    %orig();
    
    // check device for 3D touch capability
    if ([self.traitCollection respondsToSelector:@selector(forceTouchCapability)] &&
        self.traitCollection.forceTouchCapability == UIForceTouchCapabilityAvailable) {
        
        [self registerForPreviewingWithDelegate:self sourceView:self.tableView];
        
    }
}

// peek (working)
//- (UIViewController *)previewingContext:(id<UIViewControllerPreviewing>)previewingContext viewControllerForLocation:(CGPoint)location
//{
//    if (self.presentedViewController){
//        return nil;
//    }
//    
//    
//    NSIndexPath *indexPath = [self.tableView indexPathForRowAtPoint:location];
//    UITableViewCell<Cello_MusicEntityTableViewCellValueProviding> *cell = [self.tableView cellForRowAtIndexPath:indexPath];
//    
//    // contains cached media properties
//    MusicCoalescingEntityValueProvider *coalescingEntityValueProvider;
//    coalescingEntityValueProvider = (MusicCoalescingEntityValueProvider *)cell.entityValueProvider;
//    
//    
//    MusicContextualActionsHeaderViewController *controller = nil;
//    
//    
//    if (cell) {
//        
//        //previewingContext.sourceRect = cell.frame;
//        MusicEntityValueContext *valueContext = [self cello_entityValueContextAtIndexPath:indexPath];
//        
//        //default controller
//        //UIViewController *defaultController = [self.libraryViewConfiguration previewViewControllerForEntityValueContext:valueContext fromViewController:self];
//        
//        
//        
//        controller = [[%c(MusicContextualActionsHeaderViewController) alloc] initWithEntityValueContext:valueContext
//                                                                                      contextualActions:nil];
//        controller.view.backgroundColor = [UIColor whiteColor];
//        
//        
//        
//        UIPreviewAction *playNextAction = [UIPreviewAction
//                                              actionWithTitle:@"Play Next"
//                                              style:UIPreviewActionStyleDefault
//                                              handler:^(UIPreviewAction * _Nonnull action,
//                                                        UIViewController * _Nonnull previewViewController) {
//                                                  
//                                                  [self cello_performUpNextAction:UpNextAlertAction_PlayNext forIndexPath:indexPath];
//                                                  
//                                              }];
//        
//        
//        UIPreviewAction *addToUpNextAction = [UIPreviewAction
//                                              actionWithTitle:@"Add to Up Next"
//                                              style:UIPreviewActionStyleDefault
//                                              handler:^(UIPreviewAction * _Nonnull action,
//                                                        UIViewController * _Nonnull previewViewController) {
//                                                  
//                                                  [self cello_performUpNextAction:UpNextAlertAction_AddToUpNext forIndexPath:indexPath];
//                                                  
//                                              }];
//        
//        
//        // so we know if the item is already downloaded or not
//        NSNumber *keepLocal = [coalescingEntityValueProvider valueForEntityProperty:@"keepLocal"];
//        UIPreviewAction *downloadAction = [UIPreviewAction
//                                         actionWithTitle:(keepLocal.boolValue ? @"Remove Download" : @"Download")
//                                         style:UIPreviewActionStyleDefault
//                                         handler:^(UIPreviewAction * _Nonnull action,
//                                                   UIViewController * _Nonnull previewViewController) {
//                                             
//                                             [self cello_performDownloadActionForIndexPath:indexPath];
//                                             
//                                         }];
//        
//        
//        UIPreviewAction *deleteAction = [UIPreviewAction
//                                         actionWithTitle:@"Delete"
//                                         style:UIPreviewActionStyleDestructive
//                                         handler:^(UIPreviewAction * _Nonnull action,
//                                                   UIViewController * _Nonnull previewViewController) {
//                                             
//                                             UIAlertController *deleteConfirmController = [self cello_deleteConfirmationAlertController:indexPath];
//                                             [self presentViewController:deleteConfirmController animated:YES completion:nil];
//                                             
//                                         }];
//        
//        controller.celloPreviewActionItems = @[playNextAction, addToUpNextAction, downloadAction, deleteAction];
//    }
//    
//    return controller;
//}




- (UIViewController *)previewingContext:(id<UIViewControllerPreviewing>)previewingContext viewControllerForLocation:(CGPoint)location
{
    if (self.presentedViewController){
        return nil;
    }


    NSIndexPath *indexPath = [self.tableView indexPathForRowAtPoint:location];
    UITableViewCell<Cello_MusicEntityTableViewCellValueProviding> *cell = [self.tableView cellForRowAtIndexPath:indexPath];

    // contains cached media properties
    MusicCoalescingEntityValueProvider *coalescingEntityValueProvider;
    coalescingEntityValueProvider = (MusicCoalescingEntityValueProvider *)cell.entityValueProvider;
    
    
    MusicMediaAlbumDetailViewController *previewController = nil;


    if (cell) {
        
        MusicEntityValueContext *valueContext = [self cello_entityValueContextAtIndexPath:indexPath];
        
        
        //set up actions
        UIPreviewAction *playNextAction = [UIPreviewAction
                                              actionWithTitle:@"Play Next"
                                              style:UIPreviewActionStyleDefault
                                              handler:^(UIPreviewAction * _Nonnull action,
                                                        UIViewController * _Nonnull previewViewController) {

                                                  [self cello_performUpNextAction:UpNextAlertAction_PlayNext forIndexPath:indexPath];

                                              }];


        UIPreviewAction *addToUpNextAction = [UIPreviewAction
                                              actionWithTitle:@"Add to Up Next"
                                              style:UIPreviewActionStyleDefault
                                              handler:^(UIPreviewAction * _Nonnull action,
                                                        UIViewController * _Nonnull previewViewController) {

                                                  [self cello_performUpNextAction:UpNextAlertAction_AddToUpNext forIndexPath:indexPath];

                                              }];


        // so we know if the item is already downloaded or not
        NSNumber *keepLocal = [coalescingEntityValueProvider valueForEntityProperty:@"keepLocal"];
        UIPreviewAction *downloadAction = [UIPreviewAction
                                         actionWithTitle:(keepLocal.boolValue ? @"Remove Download" : @"Download")
                                         style:UIPreviewActionStyleDefault
                                         handler:^(UIPreviewAction * _Nonnull action,
                                                   UIViewController * _Nonnull previewViewController) {

                                             [self cello_performDownloadActionForIndexPath:indexPath];

                                         }];


        UIPreviewAction *deleteAction = [UIPreviewAction
                                         actionWithTitle:@"Delete"
                                         style:UIPreviewActionStyleDestructive
                                         handler:^(UIPreviewAction * _Nonnull action,
                                                   UIViewController * _Nonnull previewViewController) {

                                             UIAlertController *deleteConfirmController = [self cello_deleteConfirmationAlertController:indexPath];
                                             [self presentViewController:deleteConfirmController animated:YES completion:nil];

                                         }];
        
        
        // set up view controller
        MPMediaQuery *albumQuery = [MPMediaQuery albumsQuery];
        MPMediaQuery *titleQuery = [MPMediaQuery songsQuery];
        
        
//        MPMediaItem *item;
//        if ([(id)valueContext.entityValueProvider isKindOfClass:[MPMediaItem class]]) {
//            item = (MPMediaItem *)valueContext.entityValueProvider;
//        } else {
//            NSLog(@"NOT MEDIA ITEM");
//        }
//        
//        NSLog(@"PAT X %@", [item valueForProperty:MPMediaItemPropertyPersistentID]);
//        NSLog(@"PAT X %@", [item valueForProperty:MPMediaItemPropertyAlbumPersistentID]);
//        NSLog(@"PAT X %@", [item valueForProperty:MPMediaItemPropertyArtistPersistentID]);
//        NSLog(@"PAT X %@", [item valueForProperty:MPMediaItemPropertyAlbumArtistPersistentID]);
//        NSLog(@"PAT X %@", [item valueForProperty:MPMediaItemPropertyGenrePersistentID]);
//        NSLog(@"PAT X %@", [item valueForProperty:MPMediaItemPropertyComposerPersistentID]);
//        NSLog(@"PAT X %@", [item valueForProperty:MPMediaItemPropertyPodcastPersistentID]);
        
        
        
        

        //**************************
        /*
         
        valueContext.entityValueProvider can be
         
        MPConcreteMediaItem
        MPConcreteMediaItemCollection
        MPConcreteMediaPlaylist
        
        */
        //**************************
        
        
        
        
        MPMediaEntity *ent = (MPMediaEntity *)valueContext.entityValueProvider;
        MPMediaItem *item = ent.representativeItem;
        
        NSLog(@"CLASS %@", valueContext.entityValueProvider);
        NSLog(@"PAT %@", @(item.albumPersistentID));
        
        //TODO: get album PID
        MPMediaPropertyPredicate *albumPIDPredicate = [MPMediaPropertyPredicate predicateWithValue:@(item.albumPersistentID)
                                                                                       forProperty:MPMediaItemPropertyAlbumPersistentID];
        [albumQuery addFilterPredicate:albumPIDPredicate];
        [titleQuery addFilterPredicate:albumPIDPredicate];
        
        MusicMediaEntityProvider *albumProvider = [[%c(MusicMediaEntityProvider) alloc] initWithMediaQuery:albumQuery];
        MusicMediaEntityProvider *titleProvider = [[%c(MusicMediaEntityProvider) alloc] initWithMediaQuery:titleQuery];
        
        
        
        
        
        
        
        
        
        
        MusicMediaProfileDetailViewController *x = [[%c(MusicMediaProfileDetailViewController) alloc]
                                                    initWithContainerEntityProvider:albumProvider
                                                    clientContext:self.clientContext
                                                    profileType:1];
        return x;
        
        
        
        
        
        
        
        
        
        
        
        previewController = [[%c(MusicMediaAlbumDetailViewController) alloc] initWithContainerEntityProvider:albumProvider
                                                                              tracklistEntityProvider:titleProvider
                                                                                        clientContext:self.clientContext
                                                                existingJSProductNativeViewController:nil];

        previewController.celloPreviewActionItems = @[playNextAction, addToUpNextAction, downloadAction, deleteAction];
    }

    return previewController;
}










// pop (WORKING)
//- (void)previewingContext:(id<UIViewControllerPreviewing>)previewingContext commitViewController:(UIViewController *)viewControllerToCommit
//{
//    MusicContextualActionsHeaderViewController *controller = (MusicContextualActionsHeaderViewController *)viewControllerToCommit;
//    
//    // Dirty hack to simulate tapping on the header view
//    MusicContextualActionsConfiguration *tempConfig = [[%c(MusicContextualActionsConfiguration) alloc] init];
//    
//    // Set up a new MusicActionAlertController and select the header
//    tempConfig.entityValueContext = controller.entityValueContext;
//    [tempConfig _didSelectHeaderFromAlertController:[tempConfig newViewController]];
//}


- (void)previewingContext:(id<UIViewControllerPreviewing>)previewingContext commitViewController:(UIViewController *)viewControllerToCommit
{
    
    [self showViewController:viewControllerToCommit sender:self];
}



//
////MusicPreviewViewController
//%hook MusicMediaProductDetailViewController
//
//-(id)initWithContainerEntityProvider:(MusicMediaEntityProvider *)arg1
//tracklistEntityProvider:(MusicMediaEntityProvider *)arg2
//clientContext:(id)arg3
//existingJSProductNativeViewController:(id)arg4
//{
//    id x = %orig(arg1, arg2, arg3, arg4);
//    
//    NSLog(@"PAT initWithContainerEntityProvider \n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n", x, arg1, arg2, arg3, arg4);
//    
//    NSLog(@"***\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n%@\n\n\n\n***",
//          arg1.mediaQuery,
//          arg1.mediaQueryDataSource,
//          arg2.mediaQuery,
//          arg2.mediaQueryDataSource);
//    
//    return x;
//}
//
//%end


//%hook MusicMediaEntityProvider
//
//- (id)initWithMediaQuery:(id)arg1
//{
//    id x = %orig(arg1);
//
//    NSLog(@"PAT MusicMediaEntityProvider:initWithMediaQuery \n\n%@\n\n%@\n\n", x, arg1);
//
//    MPMediaQuery *albumQuery = [MPMediaQuery albumsQuery];
//    MPMediaPropertyPredicate *albumPIDPredicate = [MPMediaPropertyPredicate predicateWithValue:@(-1926277254370714218)
//                                                                                  forProperty:MPMediaItemPropertyAlbumPersistentID];
//    [albumQuery addFilterPredicate:albumPIDPredicate];
//
//    NSLog(@"ALBUM QUERY %@\n\n", albumQuery);
//
//
//
//
//
//
//
////    NSLog(@"***\n\n%@\n\n%@\n\n***",
////          arg1.mediaQuery,
////          arg1.mediaQueryDataSource);
//
//    return x;
//}
//
//%end












#pragma mark - UITableViewEditing

- (BOOL)tableView:(UITableView *)tableView canEditRowAtIndexPath:(NSIndexPath *)indexPath
{
    return YES;
}

- (void)tableView:(UITableView *)tableView commitEditingStyle:(UITableViewCellEditingStyle)editingStyle forRowAtIndexPath:(NSIndexPath *)indexPath
{
}

- (UITableViewCellEditingStyle)tableView:(UITableView *)tableView editingStyleForRowAtIndexPath:(NSIndexPath *)indexPath
{
    UITableViewCell<Cello_MusicEntityTableViewCellValueProviding> *cell = [self.tableView cellForRowAtIndexPath:indexPath];
    
    if ([(id)cell.entityValueProvider isKindOfClass:%c(MusicCoalescingEntityValueProvider)]) {
        
        // contains cached media properties
        MusicCoalescingEntityValueProvider *coalescingEntityValueProvider;
        coalescingEntityValueProvider = (MusicCoalescingEntityValueProvider *)cell.entityValueProvider;
        
        if ([[(id)coalescingEntityValueProvider.baseEntityValueProvider class] isSubclassOfClass:%c(MPMediaEntity)]){ // media cell
            
            return UITableViewCellEditingStyleDelete;
            
        }
    }
    
    
    // not a media cell
    return UITableViewCellEditingStyleNone;
}

- (BOOL)tableView:(UITableView *)tableView shouldIndentWhileEditingRowAtIndexPath:(NSIndexPath *)indexPath
{
    return NO;
}

%new
- (NSArray<UITableViewRowAction *> *)tableView:(UITableView *)tableView editActionsForRowAtIndexPath:(NSIndexPath *)indexPath
{
    UITableViewCell<Cello_MusicEntityTableViewCellValueProviding> *cell = [self.tableView cellForRowAtIndexPath:indexPath];
    // contains cached media properties
    MusicCoalescingEntityValueProvider *coalescingEntityValueProvider;
    coalescingEntityValueProvider = (MusicCoalescingEntityValueProvider *)cell.entityValueProvider;
    
    
    
    UITableViewRowAction *playNextAction = [UITableViewRowAction
                                            rowActionWithStyle:UITableViewRowActionStyleNormal
                                            title:@"Play\nNext"
                                            handler:^(UITableViewRowAction *action, NSIndexPath *indexPath) {
                                                
                                                [self cello_performUpNextAction:UpNextAlertAction_PlayNext forIndexPath:indexPath];
                                                [self.tableView setEditing:NO animated:YES];
                                                
                                            }];
    
    
    UITableViewRowAction *addToUpNextAction = [UITableViewRowAction
                                          rowActionWithStyle:UITableViewRowActionStyleNormal
                                          title:@"Up\nNext"
                                          handler:^(UITableViewRowAction *action, NSIndexPath *indexPath) {
                                              
                                              [self cello_performUpNextAction:UpNextAlertAction_AddToUpNext forIndexPath:indexPath];
                                              [self.tableView setEditing:NO animated:YES];
                                              
                                          }];
    
    
    // so we know if the item is already downloaded or not
    NSNumber *keepLocal = [coalescingEntityValueProvider valueForEntityProperty:@"keepLocal"];
    UITableViewRowAction *downloadAction = [UITableViewRowAction
                                          rowActionWithStyle:UITableViewRowActionStyleNormal
                                            title:(keepLocal.boolValue ? @"Remove\nDownload" : @"Download")
                                          handler:^(UITableViewRowAction *action, NSIndexPath *indexPath) {
                                              
                                              [CATransaction begin];
                                              [CATransaction setCompletionBlock: ^{
                                                  [self cello_performDownloadActionForIndexPath:indexPath];
                                              }];
                                              [self.tableView setEditing:NO animated:YES];
                                              [CATransaction commit];
                                              
                                              
                                          }];
    
    
    UITableViewRowAction *deleteAction = [UITableViewRowAction
                                          rowActionWithStyle:UITableViewRowActionStyleDestructive
                                          title:@"Delete"
                                          handler:^(UITableViewRowAction *action, NSIndexPath *indexPath) {
                                              
                                              UIAlertController *deleteConfirmController = [self cello_deleteConfirmationAlertController:indexPath];
                                              [self presentViewController:deleteConfirmController animated:YES completion:nil];
                                              
                                          }];
    
    
    
//    playNextButton.backgroundColor = [UIColor colorWithRed:0.1 green:0.71 blue:1.0 alpha:1.0];
//    addToUpNextButton.backgroundColor = [UIColor colorWithRed:0.97 green:0.58 blue:0.02 alpha:1.0];
//    downloadButton.backgroundColor = [UIColor colorWithRed:0.56 green:0.27 blue:0.68 alpha:1.0];
    
    playNextAction.backgroundColor = [UIColor darkGrayColor];
    addToUpNextAction.backgroundColor = [UIColor grayColor];
    downloadAction.backgroundColor = [UIColor lightGrayColor];
    
    return @[playNextAction, addToUpNextAction, downloadAction, deleteAction];
}

#pragma mark - Cello Additions

%new
- (id)cello_entityValueContextAtIndexPath:(NSIndexPath *)indexPath
{
    MusicEntityValueContext *valueContext = [self _entityValueContextAtIndexPath:indexPath];
    
    if (valueContext) {
        
        // make sure our queries are set up correctly
        valueContext.wantsItemGlobalIndex = YES;
        valueContext.wantsItemEntityValueProvider = YES;
        valueContext.wantsContainerEntityValueProvider = YES;
        valueContext.wantsItemIdentifierCollection = YES;
        valueContext.wantsContainerIdentifierCollection = YES;
        valueContext.wantsItemPlaybackContext = YES;
        valueContext.wantsContainerPlaybackContext = YES;
        [self _configureEntityValueContextOutput:valueContext forIndexPath:indexPath];
        
    }
    
    return valueContext;
}

%new
- (void)cello_performUpNextAction:(UpNextAlertAction_Type)actionType forIndexPath:(NSIndexPath *)indexPath
{
    MusicEntityValueContext *valueContext = [self cello_entityValueContextAtIndexPath:indexPath];
    
    MusicContextualUpNextAlertAction *contextAction = [%c(MusicContextualUpNextAlertAction)
                                                      contextualUpNextActionWithEntityValueContext:valueContext
                                                      insertionType:actionType
                                                      didDismissHandler:nil];
    
    [contextAction performContextualAction];
}

%new
- (void)cello_performDownloadActionForIndexPath:(NSIndexPath *)indexPath
{
    MusicEntityValueContext *valueContext = [self cello_entityValueContextAtIndexPath:indexPath];
    
    MusicContextualLibraryUpdateAlertAction *contextAction;
    [%c(MusicContextualLibraryUpdateAlertAction) getContextualLibraryAddRemoveAction:nil
                                                                     keepLocalAction:&contextAction
                                                               forEntityValueContext:valueContext
                                                          overrideItemEntityProvider:nil
                                                                shouldDismissHandler:nil
                                                       additionalPresentationHandler:nil
                                                                   didDismissHandler:nil];
    [contextAction performContextualAction];
}

%new
- (void)cello_performRemoveFromPlaylistActionForIndexPath:(NSIndexPath *)indexPath
{
    MusicEntityValueContext *valueContext = [self cello_entityValueContextAtIndexPath:indexPath];
    
    MusicContextualRemoveFromPlaylistAlertAction *contextAction;
    contextAction = [%c(MusicContextualRemoveFromPlaylistAlertAction)
                     contextualRemoveFromPlaylistActionWithEntityValueContext:valueContext];
    
    [contextAction performContextualAction];
}

%new
- (UIAlertController *)cello_deleteConfirmationAlertController:(NSIndexPath *)indexPath
{
    UITableViewCell<Cello_MusicEntityTableViewCellValueProviding> *cell = [self.tableView cellForRowAtIndexPath:indexPath];
    MusicCoalescingEntityValueProvider *coalescingEntityValueProvider;
    coalescingEntityValueProvider = (MusicCoalescingEntityValueProvider *)cell.entityValueProvider;
    
    NSString *message = [NSString stringWithFormat:@"%@ %@",
                         [coalescingEntityValueProvider cello_EntityNameBestGuess],
                         @"will also be removed from all your devices."];
    
    
    
    UIAlertController *controller = [UIAlertController alertControllerWithTitle:nil
                                                                        message:message
                                                                 preferredStyle:UIAlertControllerStyleActionSheet];
    
    UIAlertAction *cancelAction = [UIAlertAction actionWithTitle:@"Cancel"
                                                           style:UIAlertActionStyleCancel
                                                         handler:^(UIAlertAction * action) {
                                                             
                                                             [self.tableView setEditing:NO animated:YES];
                                                             
                                                         }];
    
    UIAlertAction *deleteAction = [UIAlertAction
                                   actionWithTitle:@"Delete from Music Library"
                                   style:UIAlertActionStyleDestructive
                                   handler:^(UIAlertAction * action) {
                                       
                                       MusicEntityValueContext *valueContext = [self cello_entityValueContextAtIndexPath:indexPath];
                                       
                                       MusicContextualLibraryUpdateAlertAction *contextAction;
                                       [%c(MusicContextualLibraryUpdateAlertAction) getContextualLibraryAddRemoveAction:&contextAction
                                                                                                        keepLocalAction:nil
                                                                                                  forEntityValueContext:valueContext
                                                                                             overrideItemEntityProvider:nil
                                                                                                   shouldDismissHandler:nil
                                                                                          additionalPresentationHandler:nil
                                                                                                      didDismissHandler:nil];
                                       
                                       [contextAction performContextualAction];
                                       
                                   }];
    
    // add actions
    [controller addAction:cancelAction];
    [controller addAction:deleteAction];
    
    // iPad
    UIPopoverPresentationController *popPresenter = [controller popoverPresentationController];
    popPresenter.sourceView = cell;
    popPresenter.sourceRect = cell.bounds;
    
    return controller;
}

%end















@interface MusicEntityTracklistItemTableViewCell : UITableViewCell <Cello_MusicEntityTableViewCellValueProviding>
{
}

- (BOOL)tracklistItemViewShouldLayoutAsEditing:(id)arg1;
- (void)tracklistItemViewDidSelectContextualActionsButton:(id)arg1;

@end

@interface MusicEntityHorizontalLockupTableViewCell : UITableViewCell <Cello_MusicEntityTableViewCellValueProviding>
{
}

- (BOOL)horizontalLockupViewShouldLayoutAsEditing:(id)arg1;
- (void)horizontalLockupViewDidSelectContextualActionsButton:(id)arg1;

@end




%hook MusicEntityTracklistItemTableViewCell

- (BOOL)tracklistItemViewShouldLayoutAsEditing:(id)arg1
{
    return NO;
}

- (void)tracklistItemViewDidSelectContextualActionsButton:(id)arg1
{
    if (self.isEditing) {
        return;
    }
    
    %orig();
}

%end


%hook MusicEntityHorizontalLockupTableViewCell

- (BOOL)horizontalLockupViewShouldLayoutAsEditing:(id)arg1
{
    return NO;
}

- (void)horizontalLockupViewDidSelectContextualActionsButton:(id)arg1
{
    if (self.isEditing) {
        return;
    }
    
    %orig();
}

%end




